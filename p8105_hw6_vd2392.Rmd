---
title: "Homework 6"
author: "Vihar Desu"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output: github_document
---

## Setup 

##### General
```{r general_setup}
knitr::opts_chunk$set(
  echo = TRUE,
  include = TRUE,
  message = FALSE,
  warning = FALSE
)
```

##### Installations
```{r installations}
library(tidyverse)
library(ggridges)
library(patchwork)
library(readxl)
library(viridis)
library(modelr)
library(mgcv)
library(p8105.datasets)
```

##### Visualizations
```{r visualiztion_setup}
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

### Problem 1

```{r}
homicide_df = 
  read_csv("data/homicide-data.csv", na = c("", "NA", "Unknown")) %>% 
  mutate(
    city_state = str_c(city, state, sep = ", "),
    victim_age = as.numeric(victim_age),
    resolution = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest"        ~ 0,
      disposition == "Closed by arrest"      ~ 1)
  ) %>% 
  filter(
    victim_race %in% c("White", "Black"),
    !city_state %in% c("Tulsa, AL", "Dallas, TX","Phoenix, AZ", "Kansas City, MO")) %>% 
  select(city_state, resolution, victim_age, victim_race, victim_sex)
```

```{r}
knitr::kable(head(homicide_df), "simple", caption="Source: Homicide Dataset")
```

```{r}
baltimore_df =
  homicide_df %>% 
  filter(city_state == "Baltimore, MD")

glm(resolution ~ victim_age + victim_race + victim_sex, 
    data = baltimore_df,
    family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(term, OR, starts_with("CI")) %>% 
  knitr::kable(digits = 3, caption="Source: Homicide Dataset")
```

```{r}
models_results_df = 
  homicide_df %>% 
  nest(data = -city_state) %>% 
  mutate(
    models = 
      map(.x = data, ~glm(resolution ~ victim_age + victim_race + victim_sex, data = .x, family = binomial())),
    results = map(models, broom::tidy)
  ) %>% 
  select(city_state, results) %>% 
  unnest(results) %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(city_state, term, OR, starts_with("CI")) 
```

```{r}
models_results_df %>% 
  filter(term == "victim_sexMale") %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

The results read as follows:  
The odds that a homicide goes unresolved if the victim is black is X times greater (or less than) that of the same odds if the victim were white. The results are stratified by city. From our analysis, we see mostly tight confidence intervals for our adjusted odds ratios. Albuquerque, New Mexico has the highest confidence interval and odds ratio while New York, NY has the lowest.  
---

## Problem 2

```{r}
birthweight_df = 
  read_csv("data/birthweight.csv", na = c("", "NA", "Unknown")) %>% 
  mutate(
    babysex = as.factor(case_when(
      babysex == 1 ~ "male",
      babysex == 2 ~ "female"
    )),
    malform = as.factor(case_when(
      malform == 0 ~ "absent",
      malform == 1 ~ "present"
    )),
    frace = as.factor(case_when(
      frace == 1 ~ "white",
      frace == 2 ~ "black",
      frace == 3 ~ "asian",
      frace == 4 ~ "puerto_rican",
      frace == 8 ~ "other",
      frace == 9 ~ "unknown"
    )),
    mrace = as.factor(case_when(
      mrace == 1 ~ "white",
      mrace == 2 ~ "black",
      mrace == 3 ~ "asian",
      mrace == 4 ~ "puerto_rican",
      mrace == 8 ~ "other",
      mrace == 9 ~ "unknown"
    ))
  )
```

```{r}
birthweight_df
#knitr::kable(head(birthweight_df), "simple", caption="Source: Birthweight Dataset")
```

```{r}
model_one = lm(bwt ~ frace + mrace + blength, data = birthweight_df)

birthweight_df %>% 
  modelr::add_residuals(model_one) %>% 
  modelr::add_predictions(model_one) %>% 
  ggplot(aes(x = frace, y = resid, color=frace)) +
  geom_violin() +
  labs(title = "Residuals against Fitted Values (Father's Race)",
       x = "Father's Race",
       y = "Residuals (grams)")

birthweight_df %>% 
  modelr::add_residuals(model_one) %>% 
  modelr::add_predictions(model_one) %>% 
  ggplot(aes(x = mrace, y = resid, color=mrace)) +
  geom_violin() +
  labs(title = "Residuals against Fitted Values (Mother's Race)",
       x = "Mother's Race",
       y = "Residuals (grams)")

birthweight_df %>% 
  modelr::add_residuals(model_one) %>% 
  modelr::add_predictions(model_one) %>% 
  ggplot(aes(x = blength, y = resid)) +
  geom_point() +
  labs(title = "Residuals against Fitted Values (Baby Length)",
       x = "Baby Length (cm)",
       y = "Residuals (grams)")
```

The process taken to evaluate a regression model for birth weight involved a hypothesized structure of the factors of interest. Given the data available, I short listed the variables to include only the subset of variables that could be predispositions or genetically inherited. Some factors may proxy or confound genetic predisposition or inheritance and were included as well. Then, the residuals were inspected and certain variables were removed where the residuals against the fitted values did not provide much meaning i.e. the spread of the residuals was large. 


```{r}

model_two = lm(bwt ~ gaweeks + blength, data = birthweight_df)
model_three = lm(bwt ~ babysex + bhead + blength + (babysex * bhead) + (blength * bhead) + (babysex * blength)  + (babysex * bhead * blength), data = birthweight_df)

birthweight_df %>% 
  gather_predictions(model_one, model_two, model_three) %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = blength, y = bwt)) + 
  geom_point(alpha = .5) +
  geom_line(aes(y = pred), color = "red") + 
  facet_grid(~model)
```

```{r}
set.seed(1)
cv_df =
  crossv_mc(birthweight_df, 100) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

cv_df = 
  cv_df %>% 
  mutate(
    model_one  = map(train, ~lm(bwt ~ frace + mrace + blength, data = .x)),
    model_two   = map(train, ~lm(bwt ~ gaweeks + blength, data = .x)),
    model_three  = map(train, ~lm(bwt ~ babysex + bhead + blength + (babysex * bhead) + (blength * bhead) + (babysex * blength)  + (babysex * bhead * blength), data =  as_tibble(.x)))) %>% 
  mutate(
    rmse_one = map2_dbl(model_one, test, ~rmse(model = .x, data = .y)),
    rmse_two    = map2_dbl(model_two, test, ~rmse(model = .x, data = .y)),
    rmse_three = map2_dbl(model_three, test, ~rmse(model = .x, data = .y)))

cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()
```

